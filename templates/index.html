<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
        :root {
            /* Define new color palette for consistency */
            --primary-color: #007bff; /* Electric Blue */
            --secondary-color: #6c757d; /* Soft Gray */
            --background-light: #f8f9fa; /* Very Light Gray */
            --panel-bg: rgba(255, 255, 255, 0.85); /* Semi-transparent White */
            --text-color-dark: #212529;
            --border-color: rgba(0, 123, 255, 0.2);
            --shadow-soft: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Roboto', sans-serif; /* Apply new font */
            background-color: var(--background-light);
        }
        #map {
            height: 100%;
            width: 100%;
        }
        .control-panel {
            position: absolute;
            top: 30px;
            left: 30px;
            z-index: 1000;
            /* Glassmorphism/Modern Look */
            background: var(--panel-bg);
            backdrop-filter: blur(10px); /* Key for glassmorphism */
            -webkit-backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: 18px;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border-color);
            min-width: 280px;
            max-width: 350px;
            animation: fadeInPanel 0.7s;
            transition: box-shadow 0.3s;
        }
        @keyframes fadeInPanel {
            from { opacity: 0; transform: translateY(-20px);}
            to { opacity: 1; transform: translateY(0);}
        }

        /* --- Panel Content Styles --- */
        .control-panel h5 {
            margin-bottom: 20px;
            font-size: 1.35rem;
            font-weight: 700;
            color: var(--primary-color);
            text-align: center;
        }
        .control-panel label {
            font-weight: 500;
            color: var(--text-color-dark);
            margin-bottom: 5px;
            display: block;
        }

        /* Form Controls */
        .form-control, select {
            border-radius: 10px;
            border: 1px solid var(--border-color);
            font-size: 1rem;
            margin-bottom: 15px;
            padding: 10px 15px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .form-control:focus, select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* Buttons */
        .btn {
            margin-bottom: 10px;
            font-size: 0.95rem;
            border-radius: 10px;
            font-weight: 500;
            padding: 10px 15px;
            transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn-group-toggle .btn {
            margin-bottom: 0;
        }
        .btn-primary {
            background: var(--primary-color);
            border: none;
            color: #fff;
        }
        .btn-primary:hover {
            background: #0056b3; /* Darker blue on hover */
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
            transform: translateY(-1px);
        }
        
        /* Secondary/Toggle Buttons for a cleaner look */
        .btn-outline-primary {
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            background: transparent;
        }
        .btn-outline-primary:hover {
            background: var(--primary-color);
            color: white;
        }

        /* Active Toggle State */
        .btn-outline-primary.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.4);
        }
        
        /* Result Panel */
        #distance-time-result {
            margin-top: 20px;
            padding: 15px;
            background: var(--background-light); /* Lighter background for results */
            border: 1px dashed var(--border-color);
            border-radius: 12px;
            color: var(--text-color-dark);
            font-size: 1.05rem;
            line-height: 1.6;
            min-height: 50px;
            font-weight: 400;
        }
        #distance-time-result b {
            font-weight: 700;
            color: #343a40;
        }

    </style>
    <title>Minimalist Navigator Map</title>
</head>
<body>

    <div id="map"></div>

    <div class="control-panel">
        <h5>üåç Minimalist Navigator</h5>

        <div class="form-group">
            <label for="algorithmSelect">Ch·ªçn Thu·∫≠t to√°n T√¨m ki·∫øm:</label>
            <select id="algorithmSelect" class="form-control">
                <option value="Dijkstra">Dijkstra (BFS)</option>
                <option value="A Star">A Star</option>
                <option value="UCS">Uniform Cost Search</option>
                <option value="Greedy BFS">Greedy Best-First Search</option>
            </select>
        </div>

        <div class="btn-group btn-group-toggle w-100" data-toggle="buttons" role="group">
            <button id="toggleNodes" class="btn btn-outline-primary w-50 active">Hi·ªán Nodes</button>
            <button id="togglePaths" class="btn btn-outline-primary w-50 active">Hi·ªán Paths</button>
        </div>
        
        <small class="form-text text-muted mb-3 mt-1 text-center">
            Click v√†o b·∫£n ƒë·ªì 2 l·∫ßn ƒë·ªÉ ch·ªçn ƒëi·ªÉm B·∫Øt ƒë·∫ßu v√† K·∫øt th√∫c.
        </small>
        
        <hr class="my-3" style="border-top: 1px solid rgba(0, 123, 255, 0.1);">

        <div id="distance-time-result">
            Ch·ªù ng∆∞·ªùi d√πng ch·ªçn ƒëi·ªÉm...
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Kh·ªüi t·∫°o b·∫£n ƒë·ªì
        var map = L.map('map').setView([21.033, 105.825], 15);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Safely pass the Python data (assuming you are using a Python backend like Flask)
        // **Ch√∫ √Ω:** C√°c bi·∫øn n√†y (node_coords, path_coords) c·∫ßn ƒë∆∞·ª£c render t·ª´ backend c·ªßa b·∫°n
        var nodes = JSON.parse('{{ node_coords|tojson|safe }}' || '[]');
        var paths = JSON.parse('{{ path_coords|tojson|safe }}' || '[]');

        // T·∫°o c√°c layer group
        var nodeMarkers = L.layerGroup();
        var pathMarkers = L.layerGroup();

        // Th√™m markers cho nodes
        nodes.forEach(function(coord) {
            var marker = L.circleMarker(coord, {
                radius: 4, // Gi·∫£m k√≠ch th∆∞·ªõc node m·ªôt ch√∫t cho tinh t·∫ø
                color: '#007bff',
                fillColor: '#007bff',
                fillOpacity: 0.7
            });
            marker.addTo(nodeMarkers);
        });
        nodeMarkers.addTo(map); // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã

        // Th√™m polylines cho paths
        paths.forEach(function(path) {
            var polyline = L.polyline(path, { color: '#6c757d', weight: 2, opacity: 0.6 }); // M√†u x√°m, m·ªèng h∆°n
            polyline.addTo(pathMarkers);
        });
        pathMarkers.addTo(map); // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã

        // X·ª≠ l√Ω n√∫t Toggle Nodes
        document.getElementById('toggleNodes').addEventListener('click', function() {
            var btn = this;
            if (map.hasLayer(nodeMarkers)) {
                map.removeLayer(nodeMarkers);
                btn.classList.remove('active');
            } else {
                map.addLayer(nodeMarkers);
                btn.classList.add('active');
            }
        });

        // X·ª≠ l√Ω n√∫t Toggle Paths
        document.getElementById('togglePaths').addEventListener('click', function() {
            var btn = this;
            if (map.hasLayer(pathMarkers)) {
                map.removeLayer(pathMarkers);
                btn.classList.remove('active');
            } else {
                map.addLayer(pathMarkers);
                btn.classList.add('active');
            }
        });

        // Bi·∫øn to√†n c·ª•c cho t∆∞∆°ng t√°c tr√™n b·∫£n ƒë·ªì
        var click_coords = [];
        var start_marker, end_marker, shortest_path_polyline; 
        
        // C·∫≠p nh·∫≠t: Icon ƒë·∫πp h∆°n cho Start/End - D·∫•u ghim t∆∞∆°ng t·ª± Google Maps
        var startIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png', // D·∫•u ghim m√†u xanh
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        var endIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', // D·∫•u ghim m√†u ƒë·ªè
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });


        map.on('click', function(e) {
            if (click_coords.length >= 2) {
                // Reset b·∫£n ƒë·ªì
                click_coords = [];
                if (start_marker) map.removeLayer(start_marker);
                if (end_marker) map.removeLayer(end_marker);
                if (shortest_path_polyline) map.removeLayer(shortest_path_polyline);
                $('#distance-time-result').html("Ch·ªù ng∆∞·ªùi d√πng ch·ªçn ƒëi·ªÉm...");
            }

            var lat = e.latlng.lat;
            var lng = e.latlng.lng;

            click_coords.push([lat, lng]);

            if (click_coords.length == 1) {
                // Th√™m ƒëi·ªÉm B·∫Øt ƒë·∫ßu
                start_marker = L.marker([lat, lng], { icon: startIcon }).addTo(map).bindPopup("Start Point").openPopup();
            } else if (click_coords.length == 2) {
                // Th√™m ƒëi·ªÉm K·∫øt th√∫c
                end_marker = L.marker([lat, lng], { icon: endIcon }).addTo(map).bindPopup("End Point").openPopup();

                // L·∫•y thu·∫≠t to√°n
                var algorithm = document.getElementById('algorithmSelect').value;
                $('#distance-time-result').html("ƒêang t√≠nh to√°n ƒë∆∞·ªùng ƒëi...");

                // 1. T√¨m ƒë∆∞·ªùng ƒëi ng·∫Øn nh·∫•t
                $.ajax({
                    url: "/find_shortest_path",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        start: click_coords[0],
                        end: click_coords[1],
                        algorithm: algorithm,
                        max_depth: 0 
                    }),
                    success: function(response) {
                        // X√≥a ƒë∆∞·ªùng c≈© n·∫øu c√≥
                        if (shortest_path_polyline) map.removeLayer(shortest_path_polyline);
                        
                        // V·∫Ω ƒë∆∞·ªùng ƒëi m·ªõi: M√†u ƒê·ªè ƒë·∫≠m h∆°n, n√©t li·ªÅn
                        var latlngs = response.path_coords;
                        shortest_path_polyline = L.polyline(latlngs, { color: 'red', weight: 5, opacity: 0.9 }).addTo(map);
                        map.fitBounds(shortest_path_polyline.getBounds(), { padding: [50, 50] });

                        // 2. T√≠nh kho·∫£ng c√°ch & th·ªùi gian (Ch·ªâ g·ªçi khi t√¨m ƒë∆∞·ª£c ƒë∆∞·ªùng ƒëi th√†nh c√¥ng)
                        $.ajax({
                            url: "/estimate_distance_time",
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify({
                                start: click_coords[0],
                                end: click_coords[1],
                                speed: 1.39 
                            }),
                            success: function(response) {
                                var distance = response.distance_m ? response.distance_m.toFixed(1) : "N/A";
                                var time = response.estimated_time_s ? (response.estimated_time_s/60).toFixed(1) : "N/A";
                                
                                $('#distance-time-result').html(
                                    "<b>‚ú® K·∫øt qu·∫£ t√≠nh to√°n</b><br>" +
                                    "<i class='fas fa-road'></i> <b>Kho·∫£ng c√°ch:</b> " + distance + " m<br>" +
                                    "<i class='fas fa-clock'></i> <b>Th·ªùi gian:</b> " + time + " ph√∫t (v=" + (1.39 * 3.6).toFixed(1) + " km/h)"
                                );
                            },
                            error: function(error) {
                                $('#distance-time-result').html("<b>‚ö†Ô∏è L·ªói:</b> Kh√¥ng th·ªÉ t√≠nh kho·∫£ng c√°ch/th·ªùi gian.");
                            }
                        });
                    },
                    error: function(error) {
                        console.error(error);
                        $('#distance-time-result').html("<b>‚ö†Ô∏è L·ªói:</b> Kh√¥ng t√¨m th·∫•y ƒë∆∞·ªùng ƒëi (" + error.responseJSON.error + ")");
                    }
                });
            }
        });
    </script>
</body>
</html>